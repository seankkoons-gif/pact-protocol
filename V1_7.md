# PACT v1.7

PACT v1.7 builds on v1.6 by adding a Stripe-like settlement provider implementation, demonstrating how external payment rails can be integrated using the lifecycle API.

---

## Summary

v1.7 introduces:

1. **Stripe-like Settlement Provider**: Simulated Stripe payment semantics (authorize/capture/void) using the lifecycle API
2. **Async Settlement Simulation**: Support for pending/committed/failed statuses with retries and reconciliation (v1.7.2+)
3. **Engine Integration**: Settlement lifecycle wired into engine for hash_reveal mode (v1.7.3+)
4. **Payment Intent Semantics**: Maps to real Stripe payment_intent patterns for future integration
5. **Backward Compatibility**: Default behavior remains unchanged (mock provider)

This prepares for real Stripe adapter integration while maintaining full backward compatibility with v1.6.

---

## Stripe-like Settlement Provider (v1.7.1+)

v1.7.1 introduces `StripeLikeSettlementProvider`, a simulated Stripe payment provider that demonstrates how external payment rails can be integrated using the lifecycle API (v1.6.1+).

### Overview

The Stripe-like provider maps PACT lifecycle operations to Stripe payment semantics:

- **`prepare()`** = Stripe **"authorize"** / create payment_intent
- **`commit()`** = Stripe **"capture"** payment_intent
- **`abort()`** = Stripe **"void authorization"** / cancel payment_intent

All operations are idempotent and use the same underlying accounting logic as `MockSettlementProvider`, but add Stripe-like metadata (payment_intent_id, capture_id, etc.).

### Provider Type

```typescript
settlement: {
  provider: "stripe_like",
}
```

### Usage

**In acquire() input:**
```typescript
const result = await acquire({
  input: {
    intentType: "weather.data",
    scope: "NYC",
    constraints: { latency_ms: 50, freshness_sec: 10 },
    maxPrice: 0.0001,
    settlement: {
      provider: "stripe_like",
      idempotency_key: "retry-abc-123", // Optional, for lifecycle idempotency
    },
  },
  // ... other params
});
```

**Via CLI:**
```bash
pnpm demo --settlementProvider stripe_like
```

### Stripe-like Metadata

The provider adds Stripe-like metadata to handles and results:

**Prepare (authorize):**
- `auth_id`: Payment intent ID (format: `pi_<handle_id>`)
- `payment_intent_id`: Alias for `auth_id`

**Commit (capture):**
- `capture_id`: Capture ID (format: `capt_<hash>`)
- `payment_intent_id`: Original payment intent ID

**Abort (void):**
- `void_reason`: Optional reason for void (stored in handle meta)

### Behavior

**Prepare (authorize):**
- Locks funds from buyer's available balance
- Creates deterministic handle_id (payment_intent_id) from `intent_id + idempotency_key`
- Returns handle with `auth_id` in meta
- **Idempotent**: Same `(intent_id, idempotency_key)` returns same handle

**Commit (capture):**
- Transfers locked funds from buyer to seller
- Updates handle status to `"committed"`
- Returns result with `capture_id` in meta
- **Idempotent**: Same `handle_id` returns same result (no double-payment)

**Abort (void):**
- Releases locked funds back to buyer's available balance
- Updates handle status to `"aborted"`
- Stores `void_reason` in handle meta if provided
- **Idempotent**: Safe to call multiple times
- **Cannot abort after commit**: Throws error (void after capture not allowed in Stripe semantics)

### Implementation Details

The provider wraps a `MockSettlementProvider` internally, delegating all accounting operations to it while adding Stripe-like semantics:

```typescript
class StripeLikeSettlementProvider implements SettlementProvider {
  private mockProvider: MockSettlementProvider;
  
  async prepare(intent: SettlementIntent): Promise<SettlementHandle> {
    // Lock funds via mock provider
    this.mockProvider.lock(intent.from, intent.amount);
    
    // Create handle with Stripe-like metadata
    const auth_id = `pi_${handle_id}`;
    return {
      handle_id,
      status: "prepared",
      meta: {
        auth_id,
        payment_intent_id: auth_id,
        // ... other meta
      },
    };
  }
  
  async commit(handle_id: string): Promise<SettlementResult> {
    // Transfer funds via mock provider
    this.mockProvider.unlock(intentFrom, amount);
    this.mockProvider.debit(intentFrom, amount);
    this.mockProvider.credit(intentTo, amount);
    
    // Return result with capture_id
    const capture_id = this.generateCaptureId(handle_id);
    return {
      status: "committed",
      paid_amount: handle.locked_amount,
      meta: {
        capture_id,
        payment_intent_id: handle.meta?.auth_id,
      },
    };
  }
  
  async abort(handle_id: string, reason?: string): Promise<void> {
    // Release funds via mock provider
    this.mockProvider.unlock(intentFrom, amount);
    
    // Update handle status
    handle.status = "aborted";
    if (reason) {
      handle.meta = { ...handle.meta, void_reason: reason };
    }
  }
}
```

### Factory Integration

The provider is available via the settlement provider factory:

```typescript
import { createSettlementProvider } from "@pact/sdk";

const provider = createSettlementProvider({
  provider: "stripe_like",
});
```

### Demo Usage

**CLI Flag:**
```bash
# Use stripe_like provider
pnpm demo --settlementProvider stripe_like

# Use mock provider (default)
pnpm demo

# Use external provider
pnpm demo --settlementProvider external
```

**Default Behavior:**
- If `--settlementProvider` is not specified, uses `mock` provider (backward compatible)
- Explicit `settlement` parameter in code still works (input config takes precedence if provided)

### Testing

Comprehensive tests cover:
- ✅ Prepare idempotency (same handle for same inputs)
- ✅ Commit idempotency (no double-payment)
- ✅ Abort releases funds (balance restored)
- ✅ Abort is idempotent (safe to call multiple times)
- ✅ Abort after commit throws error (cannot void after capture)
- ✅ Stripe-like metadata (auth_id, capture_id, payment_intent_id)
- ✅ Multiple handles with different IDs

See `packages/sdk/src/settlement/__tests__/stripe_like.test.ts` for full test coverage.

### Future Integration

This provider serves as a template for real Stripe adapter integration:

**Current (simulated):**
- Uses `MockSettlementProvider` internally
- Deterministic IDs (no real Stripe API calls)
- No external dependencies

**Future (real Stripe adapter):**
- Replace `MockSettlementProvider` with real Stripe API client
- Use real Stripe payment_intent IDs from API responses
- Handle async operations (webhooks, confirmations)
- Support real Stripe credentials (API keys, secrets)

**Example Future Implementation:**
```typescript
class StripeSettlementProvider implements SettlementProvider {
  private stripeClient: Stripe;
  
  async prepare(intent: SettlementIntent): Promise<SettlementHandle> {
    // Create real Stripe payment_intent
    const paymentIntent = await this.stripeClient.paymentIntents.create({
      amount: intent.amount * 100, // Stripe uses cents
      currency: "usd",
      idempotency_key: intent.idempotency_key,
      // ... other Stripe params
    });
    
    return {
      handle_id: paymentIntent.id,
      status: "prepared",
      meta: {
        auth_id: paymentIntent.id,
        payment_intent_id: paymentIntent.id,
      },
    };
  }
  
  async commit(handle_id: string): Promise<SettlementResult> {
    // Capture real Stripe payment_intent
    const paymentIntent = await this.stripeClient.paymentIntents.capture(handle_id);
    
    return {
      status: "committed",
      paid_amount: paymentIntent.amount / 100, // Convert from cents
      meta: {
        capture_id: paymentIntent.latest_charge?.id,
        payment_intent_id: paymentIntent.id,
      },
    };
  }
  
  async abort(handle_id: string, reason?: string): Promise<void> {
    // Cancel real Stripe payment_intent
    await this.stripeClient.paymentIntents.cancel(handle_id, {
      cancellation_reason: reason ? { reason: "requested_by_customer" } : undefined,
    });
  }
}
```

### Backward Compatibility

All v1.6 guarantees remain unchanged:
- ✅ Default behavior: No `--settlementProvider` flag → uses `mock` provider (unchanged)
- ✅ Existing demos work unchanged (pass explicit `MockSettlementProvider`)
- ✅ Protocol semantics unchanged (stripe_like is settlement-layer only)
- ✅ All tests pass with default provider

**Additive changes only**: v1.7.1 adds optional `stripe_like` provider without breaking v1.6 behavior.

---

## Async Settlement Simulation (v1.7.2+)

v1.7.2 adds async settlement simulation to `StripeLikeSettlementProvider`, allowing settlement operations to return `"pending"` status and resolve later via polling.

### Overview

Async settlement simulates real-world payment processing delays:
- **`commit()`** can return `status: "pending"` instead of immediately `"committed"`
- **`poll()`** method checks settlement status and resolves pending operations
- Supports failure scenarios where settlement resolves to `"failed"` instead of `"committed"`

### Configuration

```typescript
const settlement = new StripeLikeSettlementProvider({
  asyncCommit: true,        // Enable async commit (default: false, synchronous)
  commitDelayTicks: 3,      // Number of poll calls before commit resolves (default: 3)
  failCommit: false,        // If true, poll resolves to "failed" instead of "committed" (default: false)
});
```

### Behavior

**Synchronous (default):**
- `commit()` immediately returns `status: "committed"`
- Funds transferred immediately
- No polling required

**Async (`asyncCommit: true`):**
- `commit()` returns `status: "pending"`
- Funds remain locked (not transferred yet)
- `poll()` must be called to resolve:
  - After `commitDelayTicks` polls, resolves to `"committed"` (transfers funds) or `"failed"` (releases funds)
  - All operations are idempotent

### Auto-Polling (v1.7.3+)

For convenience in demos and tests, `acquire()` supports `auto_poll_ms` to automatically poll until settlement resolves:

```typescript
const result = await acquire({
  input: {
    // ... other input
    settlement: {
      provider: "stripe_like",
      params: {
        asyncCommit: true,
        commitDelayTicks: 3,
      },
      auto_poll_ms: 0, // 0 = immediate poll loop, >0 = delay between polls
    },
  },
  // ... other params
});
```

**Behavior:**
- If `auto_poll_ms` is set: `acquire()` polls settlement until resolved (max 10 attempts)
- If `auto_poll_ms` is 0: Polls immediately in a tight loop (for demos/tests)
- If `auto_poll_ms` is >0: Waits that many milliseconds between polls
- If `auto_poll_ms` is not set: Returns `ok: false` with code `BOND_INSUFFICIENT` (settlement pending)

**Production Usage:**
- Production clients should **not** use `auto_poll_ms` (blocking)
- Instead, poll externally using `settlement.poll(handle_id)` in a separate process/thread
- `auto_poll_ms` is an opt-in convenience for demos and tests only

### Demo Usage

**Async settlement with auto-poll:**
```bash
pnpm demo:happy -- --settlementProvider stripe_like --stripeAsync --saveTranscript
```

**Async settlement that fails:**
```bash
pnpm demo:happy -- --settlementProvider stripe_like --stripeAsync --stripeFail --saveTranscript
```

**Synchronous (default):**
```bash
pnpm demo:happy -- --settlementProvider stripe_like
```

### Transcript Integration

When async settlement is used, transcripts record the full lifecycle:

```json
{
  "settlement_lifecycle": {
    "provider": "stripe_like",
    "handle_id": "abc123",
    "status": "committed",
    "prepared_at_ms": 1000,
    "committed_at_ms": 2000,
    "paid_amount": 0.000075,
    "settlement_events": [
      { "ts_ms": 1000, "op": "prepare", "status": "prepared" },
      { "ts_ms": 1500, "op": "commit", "status": "pending" },
      { "ts_ms": 1600, "op": "poll", "status": "pending" },
      { "ts_ms": 1700, "op": "poll", "status": "pending" },
      { "ts_ms": 1800, "op": "poll", "status": "committed" }
    ]
  }
}
```

### Testing

Comprehensive tests cover:
- ✅ Async commit returns pending, poll resolves to committed
- ✅ Funds move exactly once (no double-payment)
- ✅ Fail commit releases buyer funds, seller not paid
- ✅ Idempotency: repeated commit/poll are stable
- ✅ Abort from pending releases funds
- ✅ Default behavior (asyncCommit=false) is synchronous

See `packages/sdk/src/settlement/__tests__/stripe_like_async.test.ts` for full test coverage.

---

## Engine Integration (v1.7.3+)

v1.7.3 wires the settlement lifecycle into the engine for `hash_reveal` mode, so async settlement statuses (pending/committed/failed) actually show up in transcripts and demo outputs.

### Overview

When a settlement provider supports lifecycle methods (`prepare`, `commit`, `poll`), the engine uses them instead of legacy `lock`/`unlock`/`pay` methods:

**Hash Reveal Mode:**
1. On agreement creation (ACCEPT): `settlement.prepare()` + `settlement.commit()`
2. If commit returns `"pending"`:
   - If `auto_poll_ms` is set: Poll until resolved (bounded loop)
   - If `auto_poll_ms` is not set: Return `ok: false` with `BOND_INSUFFICIENT` code
3. On successful reveal: Funds already transferred (if committed), just unlock bond
4. On failure: `settlement.abort()` to release funds

**Streaming Mode:**
- Keeps current behavior (not refactored in v1.7.3)
- Uses legacy settlement methods

### Fallback Behavior

If settlement provider does **not** support lifecycle methods:
- Engine falls back to legacy `lockFunds`/`unlock`/`pay` behavior
- No changes to existing demos or tests
- Full backward compatibility maintained

### Transcript Recording

Settlement lifecycle events are automatically recorded in transcripts:
- `prepare` events with handle_id and timestamps
- `commit` events with status (pending/committed/failed)
- `poll` events showing resolution progress
- `abort` events with reasons

See `packages/sdk/src/transcript/types.ts` for full schema.

---

## What's Next

Possible future enhancements (not in v1.7):

- **Real Stripe adapter**: Implementation using Stripe API client
- **Other payment rails**: Ethereum, Solana, PayPal, etc.
- **Async settlement**: Support for webhooks and confirmations
- **Multi-rail support**: Route to different providers based on context

These features may be considered for future versions but are explicitly **not** in v1.7.

