# PACT v1.7

PACT v1.7 builds on v1.6 by adding a Stripe-like settlement provider implementation, demonstrating how external payment rails can be integrated using the lifecycle API.

---

## Summary

v1.7 introduces:

1. **Stripe-like Settlement Provider**: Simulated Stripe payment semantics (authorize/capture/void) using the lifecycle API
2. **Payment Intent Semantics**: Maps to real Stripe payment_intent patterns for future integration
3. **Backward Compatibility**: Default behavior remains unchanged (mock provider)

This prepares for real Stripe adapter integration while maintaining full backward compatibility with v1.6.

---

## Stripe-like Settlement Provider (v1.7.1+)

v1.7.1 introduces `StripeLikeSettlementProvider`, a simulated Stripe payment provider that demonstrates how external payment rails can be integrated using the lifecycle API (v1.6.1+).

### Overview

The Stripe-like provider maps PACT lifecycle operations to Stripe payment semantics:

- **`prepare()`** = Stripe **"authorize"** / create payment_intent
- **`commit()`** = Stripe **"capture"** payment_intent
- **`abort()`** = Stripe **"void authorization"** / cancel payment_intent

All operations are idempotent and use the same underlying accounting logic as `MockSettlementProvider`, but add Stripe-like metadata (payment_intent_id, capture_id, etc.).

### Provider Type

```typescript
settlement: {
  provider: "stripe_like",
}
```

### Usage

**In acquire() input:**
```typescript
const result = await acquire({
  input: {
    intentType: "weather.data",
    scope: "NYC",
    constraints: { latency_ms: 50, freshness_sec: 10 },
    maxPrice: 0.0001,
    settlement: {
      provider: "stripe_like",
      idempotency_key: "retry-abc-123", // Optional, for lifecycle idempotency
    },
  },
  // ... other params
});
```

**Via CLI:**
```bash
pnpm demo --settlementProvider stripe_like
```

### Stripe-like Metadata

The provider adds Stripe-like metadata to handles and results:

**Prepare (authorize):**
- `auth_id`: Payment intent ID (format: `pi_<handle_id>`)
- `payment_intent_id`: Alias for `auth_id`

**Commit (capture):**
- `capture_id`: Capture ID (format: `capt_<hash>`)
- `payment_intent_id`: Original payment intent ID

**Abort (void):**
- `void_reason`: Optional reason for void (stored in handle meta)

### Behavior

**Prepare (authorize):**
- Locks funds from buyer's available balance
- Creates deterministic handle_id (payment_intent_id) from `intent_id + idempotency_key`
- Returns handle with `auth_id` in meta
- **Idempotent**: Same `(intent_id, idempotency_key)` returns same handle

**Commit (capture):**
- Transfers locked funds from buyer to seller
- Updates handle status to `"committed"`
- Returns result with `capture_id` in meta
- **Idempotent**: Same `handle_id` returns same result (no double-payment)

**Abort (void):**
- Releases locked funds back to buyer's available balance
- Updates handle status to `"aborted"`
- Stores `void_reason` in handle meta if provided
- **Idempotent**: Safe to call multiple times
- **Cannot abort after commit**: Throws error (void after capture not allowed in Stripe semantics)

### Implementation Details

The provider wraps a `MockSettlementProvider` internally, delegating all accounting operations to it while adding Stripe-like semantics:

```typescript
class StripeLikeSettlementProvider implements SettlementProvider {
  private mockProvider: MockSettlementProvider;
  
  async prepare(intent: SettlementIntent): Promise<SettlementHandle> {
    // Lock funds via mock provider
    this.mockProvider.lock(intent.from, intent.amount);
    
    // Create handle with Stripe-like metadata
    const auth_id = `pi_${handle_id}`;
    return {
      handle_id,
      status: "prepared",
      meta: {
        auth_id,
        payment_intent_id: auth_id,
        // ... other meta
      },
    };
  }
  
  async commit(handle_id: string): Promise<SettlementResult> {
    // Transfer funds via mock provider
    this.mockProvider.unlock(intentFrom, amount);
    this.mockProvider.debit(intentFrom, amount);
    this.mockProvider.credit(intentTo, amount);
    
    // Return result with capture_id
    const capture_id = this.generateCaptureId(handle_id);
    return {
      status: "committed",
      paid_amount: handle.locked_amount,
      meta: {
        capture_id,
        payment_intent_id: handle.meta?.auth_id,
      },
    };
  }
  
  async abort(handle_id: string, reason?: string): Promise<void> {
    // Release funds via mock provider
    this.mockProvider.unlock(intentFrom, amount);
    
    // Update handle status
    handle.status = "aborted";
    if (reason) {
      handle.meta = { ...handle.meta, void_reason: reason };
    }
  }
}
```

### Factory Integration

The provider is available via the settlement provider factory:

```typescript
import { createSettlementProvider } from "@pact/sdk";

const provider = createSettlementProvider({
  provider: "stripe_like",
});
```

### Demo Usage

**CLI Flag:**
```bash
# Use stripe_like provider
pnpm demo --settlementProvider stripe_like

# Use mock provider (default)
pnpm demo

# Use external provider
pnpm demo --settlementProvider external
```

**Default Behavior:**
- If `--settlementProvider` is not specified, uses `mock` provider (backward compatible)
- Explicit `settlement` parameter in code still works (input config takes precedence if provided)

### Testing

Comprehensive tests cover:
- ✅ Prepare idempotency (same handle for same inputs)
- ✅ Commit idempotency (no double-payment)
- ✅ Abort releases funds (balance restored)
- ✅ Abort is idempotent (safe to call multiple times)
- ✅ Abort after commit throws error (cannot void after capture)
- ✅ Stripe-like metadata (auth_id, capture_id, payment_intent_id)
- ✅ Multiple handles with different IDs

See `packages/sdk/src/settlement/__tests__/stripe_like.test.ts` for full test coverage.

### Future Integration

This provider serves as a template for real Stripe adapter integration:

**Current (simulated):**
- Uses `MockSettlementProvider` internally
- Deterministic IDs (no real Stripe API calls)
- No external dependencies

**Future (real Stripe adapter):**
- Replace `MockSettlementProvider` with real Stripe API client
- Use real Stripe payment_intent IDs from API responses
- Handle async operations (webhooks, confirmations)
- Support real Stripe credentials (API keys, secrets)

**Example Future Implementation:**
```typescript
class StripeSettlementProvider implements SettlementProvider {
  private stripeClient: Stripe;
  
  async prepare(intent: SettlementIntent): Promise<SettlementHandle> {
    // Create real Stripe payment_intent
    const paymentIntent = await this.stripeClient.paymentIntents.create({
      amount: intent.amount * 100, // Stripe uses cents
      currency: "usd",
      idempotency_key: intent.idempotency_key,
      // ... other Stripe params
    });
    
    return {
      handle_id: paymentIntent.id,
      status: "prepared",
      meta: {
        auth_id: paymentIntent.id,
        payment_intent_id: paymentIntent.id,
      },
    };
  }
  
  async commit(handle_id: string): Promise<SettlementResult> {
    // Capture real Stripe payment_intent
    const paymentIntent = await this.stripeClient.paymentIntents.capture(handle_id);
    
    return {
      status: "committed",
      paid_amount: paymentIntent.amount / 100, // Convert from cents
      meta: {
        capture_id: paymentIntent.latest_charge?.id,
        payment_intent_id: paymentIntent.id,
      },
    };
  }
  
  async abort(handle_id: string, reason?: string): Promise<void> {
    // Cancel real Stripe payment_intent
    await this.stripeClient.paymentIntents.cancel(handle_id, {
      cancellation_reason: reason ? { reason: "requested_by_customer" } : undefined,
    });
  }
}
```

### Backward Compatibility

All v1.6 guarantees remain unchanged:
- ✅ Default behavior: No `--settlementProvider` flag → uses `mock` provider (unchanged)
- ✅ Existing demos work unchanged (pass explicit `MockSettlementProvider`)
- ✅ Protocol semantics unchanged (stripe_like is settlement-layer only)
- ✅ All tests pass with default provider

**Additive changes only**: v1.7.1 adds optional `stripe_like` provider without breaking v1.6 behavior.

---

## What's Next

Possible future enhancements (not in v1.7):

- **Real Stripe adapter**: Implementation using Stripe API client
- **Other payment rails**: Ethereum, Solana, PayPal, etc.
- **Async settlement**: Support for webhooks and confirmations
- **Multi-rail support**: Route to different providers based on context

These features may be considered for future versions but are explicitly **not** in v1.7.

