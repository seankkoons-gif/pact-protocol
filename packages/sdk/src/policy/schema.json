{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "pact-policy/1.0/schema.json",
    "title": "Pact Policy Schema v1",
    "type": "object",
    "additionalProperties": false,
    "required": [
      "policy_version",
      "policy_id",
      "name",
      "mode",
      "created_at_ms",
      "updated_at_ms",
      "base",
      "time",
      "admission",
      "negotiation",
      "counterparty",
      "sla",
      "economics",
      "settlement",
      "anti_gaming",
      "observability",
      "overrides"
    ],
    "properties": {
      "policy_version": { "const": "pact-policy/1.0" },
      "policy_id": { "type": "string", "minLength": 8 },
      "name": { "type": "string", "minLength": 1 },
      "mode": {
        "type": "string",
        "enum": ["best_price", "balanced", "fastest", "trusted_only"]
      },
      "created_at_ms": { "type": "integer", "minimum": 0 },
      "updated_at_ms": { "type": "integer", "minimum": 0 },
  
      "base": {
        "type": "object",
        "additionalProperties": false,
        "required": ["kya"],
        "properties": {
          "kya": {
            "type": "object",
            "additionalProperties": false,
            "required": ["trust"],
            "properties": {
              "trust": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "require_trusted_issuer",
                  "require_credential",
                  "trusted_issuers",
                  "issuer_weights",
                  "min_trust_tier",
                  "min_trust_score"
                ],
                "properties": {
                  "require_trusted_issuer": { "type": "boolean" },
                  "require_credential": { "type": "boolean" },
                  "trusted_issuers": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": { "type": "string", "minLength": 1 }
                  },
                  "issuer_weights": {
                    "type": "object",
                    "additionalProperties": { "type": "number", "minimum": 0, "maximum": 1 }
                  },
                  "min_trust_tier": {
                    "type": "string",
                    "enum": ["untrusted", "low", "trusted"]
                  },
                  "min_trust_score": { "type": "number", "minimum": 0, "maximum": 1 }
                }
              }
            }
          }
        }
      },
  
      "time": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "max_clock_skew_ms",
          "require_expires_at",
          "default_message_ttl_ms",
          "min_valid_for_ms",
          "max_valid_for_ms"
        ],
        "properties": {
          "max_clock_skew_ms": { "type": "integer", "minimum": 0, "maximum": 600000 },
          "require_expires_at": { "type": "boolean" },
          "default_message_ttl_ms": { "type": "integer", "minimum": 1, "maximum": 600000 },
          "min_valid_for_ms": { "type": "integer", "minimum": 0, "maximum": 600000 },
          "max_valid_for_ms": { "type": "integer", "minimum": 1, "maximum": 600000 }
        }
      },
  
      "admission": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "require_one_of",
          "min_open_bond",
          "refund_open_bond_on_terminal",
          "open_bond_forfeit_on_timeout_by_initiator",
          "require_session_keys",
          "session_max_spend_per_hour",
          "session_intent_allowlist",
          "new_agent"
        ],
        "properties": {
          "require_one_of": {
            "type": "array",
            "minItems": 1,
            "uniqueItems": true,
            "items": {
              "type": "string",
              "enum": ["bond", "credential", "sponsor_attestation"]
            }
          },
          "min_open_bond": { "type": "number", "minimum": 0 },
          "refund_open_bond_on_terminal": { "type": "boolean" },
          "open_bond_forfeit_on_timeout_by_initiator": { "type": "number", "minimum": 0 },
  
          "require_session_keys": { "type": "boolean" },
          "session_max_spend_per_hour": { "type": "number", "minimum": 0 },
          "session_intent_allowlist": {
            "type": "array",
            "minItems": 0,
            "uniqueItems": true,
            "items": { "type": "string", "minLength": 1 }
          },
  
          "new_agent": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "is_new_below_reputation",
              "max_rounds",
              "bond_multiplier",
              "max_concurrent_negotiations"
            ],
            "properties": {
              "is_new_below_reputation": { "type": "number", "minimum": 0, "maximum": 1 },
              "max_rounds": { "type": "integer", "minimum": 0, "maximum": 10 },
              "bond_multiplier": { "type": "number", "minimum": 0 },
              "max_concurrent_negotiations": { "type": "integer", "minimum": 0, "maximum": 1000000 }
            }
          }
        }
      },
  
      "negotiation": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "max_rounds",
          "max_total_duration_ms",
          "require_firm_quotes",
          "firm_quote_valid_for_ms_range",
          "allowed_actions",
          "reject_nonconforming_messages",
          "counter_rules",
          "termination"
        ],
        "properties": {
          "max_rounds": { "type": "integer", "minimum": 0, "maximum": 20 },
          "max_total_duration_ms": { "type": "integer", "minimum": 1, "maximum": 3600000 },
          "require_firm_quotes": { "type": "boolean" },
          "firm_quote_valid_for_ms_range": {
            "type": "array",
            "items": [{ "type": "integer" }, { "type": "integer" }],
            "minItems": 2,
            "maxItems": 2
          },
          "allowed_actions": {
            "type": "array",
            "minItems": 1,
            "uniqueItems": true,
            "items": {
              "type": "string",
              "enum": ["INTENT", "ASK", "BID", "ACCEPT", "REJECT"]
            }
          },
          "reject_nonconforming_messages": { "type": "boolean" },
  
          "counter_rules": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "max_counters_by_buyer",
              "max_counters_by_seller",
              "min_step_pct",
              "max_step_pct"
            ],
            "properties": {
              "max_counters_by_buyer": { "type": "integer", "minimum": 0, "maximum": 20 },
              "max_counters_by_seller": { "type": "integer", "minimum": 0, "maximum": 20 },
              "min_step_pct": { "type": "number", "minimum": 0, "maximum": 1 },
              "max_step_pct": { "type": "number", "minimum": 0, "maximum": 10 }
            }
          },
  
          "termination": {
            "type": "object",
            "additionalProperties": false,
            "required": ["on_timeout", "on_invalid_message", "on_invariant_violation"],
            "properties": {
              "on_timeout": { "type": "string", "enum": ["TIMEOUT"] },
              "on_invalid_message": { "type": "string", "enum": ["REJECT"] },
              "on_invariant_violation": { "type": "string", "enum": ["REJECT"] }
            }
          }
        }
      },
  
      "counterparty": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "min_reputation",
          "min_age_ms",
          "exclude_new_agents",
          "require_credentials",
          "trusted_issuers",
          "max_failure_rate",
          "max_timeout_rate",
          "region_allowlist",
          "intent_specific"
        ],
        "properties": {
          "min_reputation": { "type": "number", "minimum": 0, "maximum": 1 },
          "min_age_ms": { "type": "integer", "minimum": 0 },
          "exclude_new_agents": { "type": "boolean" },
  
          "require_credentials": {
            "type": "array",
            "uniqueItems": true,
            "items": { "type": "string", "minLength": 1 }
          },
          "trusted_issuers": {
            "type": "array",
            "uniqueItems": true,
            "items": { "type": "string", "minLength": 1 }
          },
  
          "max_failure_rate": { "type": "number", "minimum": 0, "maximum": 1 },
          "max_timeout_rate": { "type": "number", "minimum": 0, "maximum": 1 },
  
          "region_allowlist": {
            "type": "array",
            "uniqueItems": true,
            "items": { "type": "string", "minLength": 1 }
          },
  
          "intent_specific": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "additionalProperties": false,
              "required": ["min_reputation", "require_credentials"],
              "properties": {
                "min_reputation": { "type": "number", "minimum": 0, "maximum": 1 },
                "require_credentials": {
                  "type": "array",
                  "uniqueItems": true,
                  "items": { "type": "string", "minLength": 1 }
                }
              }
            }
          }
        }
      },
  
      "sla": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "max_latency_ms",
          "max_freshness_sec",
          "min_accuracy",
          "verification",
          "penalties"
        ],
        "properties": {
          "max_latency_ms": { "type": "integer", "minimum": 0, "maximum": 3600000 },
          "max_freshness_sec": { "type": "integer", "minimum": 0, "maximum": 86400 },
          "min_accuracy": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
  
          "verification": {
            "type": "object",
            "additionalProperties": false,
            "required": ["require_schema_validation", "schema_id", "proof_type"],
            "properties": {
              "require_schema_validation": { "type": "boolean" },
              "schema_id": { "type": "string", "minLength": 1 },
              "proof_type": { "type": "string", "enum": ["hash_reveal", "streaming"] }
            }
          },
  
          "penalties": {
            "type": "object",
            "additionalProperties": false,
            "required": ["on_latency_breach", "on_freshness_breach", "on_invalid_proof"],
            "properties": {
              "on_latency_breach": { "$ref": "#/$defs/penaltyAction" },
              "on_freshness_breach": { "$ref": "#/$defs/penaltyAction" },
              "on_invalid_proof": { "$ref": "#/$defs/penaltyAction" }
            }
          }
        }
      },
  
      "economics": {
        "type": "object",
        "additionalProperties": false,
        "required": ["reference_price", "bonding", "timeout_fees"],
        "properties": {
          "reference_price": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "use_receipt_history",
              "lookback_count",
              "band_pct",
              "allow_band_override_if_urgent"
            ],
            "properties": {
              "use_receipt_history": { "type": "boolean" },
              "lookback_count": { "type": "integer", "minimum": 0, "maximum": 1000000 },
              "band_pct": { "type": "number", "minimum": 0, "maximum": 10 },
              "allow_band_override_if_urgent": { "type": "boolean" }
            }
          },
  
          "bonding": {
            "type": "object",
            "additionalProperties": false,
            "required": ["seller_bond_multiple", "seller_min_bond", "buyer_bond_optional", "buyer_bond_pct_of_price"],
            "properties": {
              "seller_bond_multiple": { "type": "number", "minimum": 0 },
              "seller_min_bond": { "type": "number", "minimum": 0 },
              "buyer_bond_optional": { "type": "boolean" },
              "buyer_bond_pct_of_price": { "type": "number", "minimum": 0, "maximum": 10 }
            }
          },
  
          "timeout_fees": {
            "type": "object",
            "additionalProperties": false,
            "required": ["buyer_timeout_fee", "seller_timeout_fee"],
            "properties": {
              "buyer_timeout_fee": { "type": "number", "minimum": 0 },
              "seller_timeout_fee": { "type": "number", "minimum": 0 }
            }
          }
        }
      },
  
      "settlement": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "allowed_modes",
          "default_mode",
          "pre_settlement_lock_required",
          "challenge_window_ms",
          "streaming"
        ],
        "properties": {
          "allowed_modes": {
            "type": "array",
            "minItems": 1,
            "uniqueItems": true,
            "items": { "type": "string", "enum": ["hash_reveal", "streaming"] }
          },
          "default_mode": { "type": "string", "enum": ["hash_reveal", "streaming"] },
          "pre_settlement_lock_required": { "type": "boolean" },
          "challenge_window_ms": { "type": "integer", "minimum": 0, "maximum": 3600000 },
  
          "streaming": {
            "type": "object",
            "additionalProperties": false,
            "required": ["tick_ms", "max_spend_per_minute", "cutoff_on_violation"],
            "properties": {
              "tick_ms": { "type": "integer", "minimum": 1, "maximum": 600000 },
              "max_spend_per_minute": { "type": "number", "minimum": 0 },
              "cutoff_on_violation": { "type": "boolean" }
            }
          }
        }
      },

      "settlement_routing": {
        "type": "object",
        "additionalProperties": false,
        "required": ["default_provider", "rules"],
        "properties": {
          "default_provider": {
            "type": "string",
            "enum": ["mock", "stripe_like", "external"]
          },
          "rules": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["use"],
              "properties": {
                "when": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "min_amount": { "type": "number", "minimum": 0 },
                    "max_amount": { "type": "number", "minimum": 0 },
                    "mode": { "type": "string", "enum": ["hash_reveal", "streaming"] },
                    "min_trust_tier": { "type": "string", "enum": ["untrusted", "low", "trusted"] },
                    "min_trust_score": { "type": "number", "minimum": 0, "maximum": 1 }
                  }
                },
                "use": {
                  "type": "string",
                  "enum": ["mock", "stripe_like", "external"]
                }
              }
            }
          }
        }
      },
  
      "anti_gaming": {
        "type": "object",
        "additionalProperties": false,
        "required": ["rate_limits", "quote_accountability", "collusion"],
        "properties": {
          "rate_limits": {
            "type": "object",
            "additionalProperties": false,
            "required": ["per_agent_per_intent_per_min", "max_concurrent_negotiations", "probe_retry_cost"],
            "properties": {
              "per_agent_per_intent_per_min": { "type": "integer", "minimum": 0, "maximum": 1000000 },
              "max_concurrent_negotiations": { "type": "integer", "minimum": 0, "maximum": 1000000 },
              "probe_retry_cost": { "type": "number", "minimum": 0 }
            }
          },
  
          "quote_accountability": {
            "type": "object",
            "additionalProperties": false,
            "required": ["min_honor_rate", "penalty_on_low_honor"],
            "properties": {
              "min_honor_rate": { "type": "number", "minimum": 0, "maximum": 1 },
              "penalty_on_low_honor": {
                "type": "object",
                "additionalProperties": false,
                "required": ["increase_bond_multiplier"],
                "properties": {
                  "increase_bond_multiplier": { "type": "number", "minimum": 0, "maximum": 100 }
                }
              }
            }
          },
  
          "collusion": {
            "type": "object",
            "additionalProperties": false,
            "required": ["min_economic_substance", "max_counterparty_concentration_pct", "rep_gain_discount_on_clique"],
            "properties": {
              "min_economic_substance": { "type": "number", "minimum": 0 },
              "max_counterparty_concentration_pct": { "type": "number", "minimum": 0, "maximum": 1 },
              "rep_gain_discount_on_clique": { "type": "number", "minimum": 0, "maximum": 1 }
            }
          }
        }
      },
  
      "observability": {
        "type": "object",
        "additionalProperties": false,
        "required": ["emit_receipts", "receipt_fields", "store_full_transcripts", "expose_explanations"],
        "properties": {
          "emit_receipts": { "type": "boolean" },
          "receipt_fields": {
            "type": "array",
            "minItems": 0,
            "uniqueItems": true,
            "items": { "type": "string", "minLength": 1 }
          },
          "store_full_transcripts": { "type": "boolean" },
          "expose_explanations": {
            "type": "object",
            "additionalProperties": false,
            "required": ["enabled", "max_detail"],
            "properties": {
              "enabled": { "type": "boolean" },
              "max_detail": { "type": "string", "enum": ["none", "coarse"] }
            }
          }
        }
      },
  
      "overrides": {
        "type": "object",
        "additionalProperties": false,
        "required": ["allowed", "types", "mid_round_intervention", "kill_switch", "budgets"],
        "properties": {
          "allowed": { "type": "boolean" },
          "types": {
            "type": "array",
            "uniqueItems": true,
            "items": { "type": "string", "enum": ["policy_swap", "kill_switch", "budget_cap_update"] }
          },
          "mid_round_intervention": { "type": "boolean", "const": false },
  
          "kill_switch": {
            "type": "object",
            "additionalProperties": false,
            "required": ["enabled", "halt_on_trigger"],
            "properties": {
              "enabled": { "type": "boolean" },
              "halt_on_trigger": { "type": "boolean" }
            }
          },
  
          "budgets": {
            "type": "object",
            "additionalProperties": false,
            "required": ["max_spend_per_day", "max_spend_per_intent_per_day"],
            "properties": {
              "max_spend_per_day": { "type": "number", "minimum": 0 },
              "max_spend_per_intent_per_day": {
                "type": "object",
                "additionalProperties": { "type": "number", "minimum": 0 }
              }
            }
          }
        }
      },

      "paid": {
        "type": "object",
        "additionalProperties": false,
        "required": [],
        "properties": {
          "fast_lane": {
            "type": "boolean",
            "description": "Priority negotiation/settlement (v1: no-op, reserved for future monetization)"
          },
          "extra_fanout": {
            "type": "integer",
            "minimum": 0,
            "description": "Additional sellers to query beyond default (v1: no-op, reserved for future monetization)"
          },
          "priority_settlement": {
            "type": "boolean",
            "description": "Expedited settlement processing (v1: no-op, reserved for future monetization)"
          },
          "reputation_boost": {
            "type": "boolean",
            "description": "Bonded/verified reputation boost (v1: no-op, must be verified not fake, reserved for future monetization)"
          }
        }
      }
    },
  
    "$defs": {
      "penaltyAction": {
        "type": "object",
        "additionalProperties": false,
        "required": ["action", "value"],
        "properties": {
          "action": {
            "type": "string",
            "enum": ["auto_refund_pct", "full_refund", "slash_seller_bond_pct"]
          },
          "value": { "type": "number", "minimum": 0, "maximum": 1 }
        }
      }
    }
  }
  