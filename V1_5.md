# PACT v1.5

PACT v1.5 builds on the stable v1.0 foundation by adding provider identity modes and Know Your Agent (KYA) credential verification, without changing core protocol semantics.

---

## Summary

v1.5 introduces:

1. **Provider Identity Modes**: Flexible identity management for production deployments (env secret key, keypair file, dev seed, ephemeral)
2. **Credential Verification**: HTTP providers present signed credentials that buyers verify before negotiation
3. **Backward Compatibility**: All v1.0 guarantees remain unchanged; v1.5 is additive only

These features enhance security and identity verification while maintaining full compatibility with v1.0 providers and buyers.

---

## Provider Identity Modes

PACT v1.5 introduces production-ready provider identity management while preserving backward compatibility with v1.0 demos.

### Identity Loading Precedence

Provider identity is loaded in the following order (first available wins):

1. **`PACT_PROVIDER_SECRET_KEY_B58`** (env var)
   - Base58-encoded 64-byte Ed25519 secret key
   - Highest precedence for production deployments
   - Example: `export PACT_PROVIDER_SECRET_KEY_B58="<base58_secret_key>"`

2. **`PACT_PROVIDER_KEYPAIR_FILE`** (env var)
   - Path to JSON file containing:
     ```json
     {
       "secretKeyB58": "<base58_secret_key>",
       "publicKeyB58": "<base58_public_key>" // optional, validated if provided
     }
     ```
   - Example: `export PACT_PROVIDER_KEYPAIR_FILE="/path/to/keypair.json"`

3. **`PACT_DEV_IDENTITY_SEED`** (env var - explicit opt-in)
   - Deterministic dev identity seed (must be explicitly set)
   - **Warning**: Only for development/testing
   - Example: `export PACT_DEV_IDENTITY_SEED="my-dev-seed"`
   - If not set, falls back to ephemeral

4. **Ephemeral keypair** (fallback)
   - Random keypair generated on each server start
   - No warning (acceptable for testing/demos)
   - Identity changes on each restart

### Breaking Changes

- **v1.0 behavior preserved**: If no env vars are set, server uses ephemeral keypair (no warning)
- **v1.0 dev seed behavior**: Only used if `PACT_DEV_IDENTITY_SEED` is explicitly set
- **Warning messages**: Only printed for deterministic dev seed (mode 3), not for ephemeral

---

## Know Your Agent (KYA) Credentials

PACT v1.5 adds credential-based identity verification for HTTP providers, enabling buyers to verify provider capabilities before negotiation begins.

### Credential Schema

Credentials are signed capability attestations:

```typescript
{
  protocol_version: "pact/1.0",
  credential_version: "1",
  credential_id: string;              // Unique identifier
  provider_pubkey_b58: string;        // Provider's public key
  issuer: string;                     // For v1.5, allows "self" for self-signed
  issued_at_ms: number;
  expires_at_ms: number;
  capabilities: Array<{
    intentType: string;               // e.g., "weather.data"
    modes: ("hash_reveal" | "streaming")[];
    region?: string;
    credentials?: string[];            // e.g., ["sla_verified"]
  }>;
  nonce: string;                      // Random nonce
}
```

### Credential Endpoint

Providers expose credentials via:

```
GET /credential?intent=<intentType>
```

Returns a signed envelope containing the credential message.

### Credential Verification

Buyers automatically fetch and verify credentials for HTTP providers:

1. **Signature verification**: Credential envelope signature must be valid
2. **Signer match**: Credential signer must match provider's directory `pubkey_b58`
3. **Expiration check**: Credential must not be expired (`expires_at_ms >= now`)
4. **Capability check**: Credential must support the requested intent type

If any verification fails, the provider is marked ineligible with `PROVIDER_CREDENTIAL_INVALID`.

### Graceful Degradation

For backward compatibility with v1.0 providers that don't implement credentials:

- **404 Not Found**: Credential endpoint missing → Provider is allowed (legacy support)
- **Other errors**: Credential fetch/parse errors → Provider is marked ineligible

This ensures v1.5 buyers can still work with v1.0 providers while encouraging credential adoption.

### Integration with acquire()

Credential verification happens automatically in `acquire()` for HTTP providers:

- Runs **before** quote fetching (early rejection)
- Logged in explain decision log if `explain !== "none"`
- Failure code: `PROVIDER_CREDENTIAL_INVALID` with reason in explain log

---

## v1.0 Compatibility

All v1.0 guarantees remain unchanged:

- ✅ Protocol semantics (envelope signing, signer/pubkey match, commit-reveal verification)
- ✅ Receipt schema (unchanged)
- ✅ Settlement modes (hash_reveal, streaming)
- ✅ Failure codes (unchanged, with new additive codes)
- ✅ Deterministic outcomes
- ✅ Demo compatibility (all demos continue to work)

**Additive changes only**: v1.5 adds new optional features without breaking v1.0 behavior.

---

## Migration Guide

### For Provider Developers

**To use production identity:**
```bash
# Option 1: Environment variable
export PACT_PROVIDER_SECRET_KEY_B58="<your_base58_secret_key>"
pnpm provider:serve

# Option 2: Keypair file
export PACT_PROVIDER_KEYPAIR_FILE="/path/to/keypair.json"
pnpm provider:serve
```

**To implement credential endpoint:**
- Provider server automatically exposes `GET /credential`
- Credentials are self-signed by default (issuer: "self")
- Capabilities are configured in `handleCredential` (can be extended via config/env)

**For development/testing:**
- No changes needed — ephemeral keypairs work fine
- To use deterministic dev identity: `export PACT_DEV_IDENTITY_SEED="my-seed"`

### For Buyer Developers

**No changes required** — credential verification happens automatically.

- Credentials are verified transparently for HTTP providers
- Legacy providers (without credential endpoint) continue to work
- Use `explain: "coarse"` or `explain: "full"` to see credential verification in decision log

---

## New Failure Codes

v1.5 adds one new failure code (additive, not breaking):

- `PROVIDER_CREDENTIAL_INVALID`: Credential verification failed (signature, signer mismatch, expired, or intent not supported)

This code is only used when credential verification is attempted and fails. Providers without credential endpoints don't trigger this code (graceful degradation).

---

## Testing

All v1.0 tests continue to pass. New tests added:

- **Provider identity loading** (`packages/provider-adapter/src/__tests__/keypair.test.ts`)
- **Credential fetching** (`packages/sdk/src/adapters/http/__tests__/credential.test.ts`)
- **Credential verification in acquire()** (`packages/sdk/src/client/__tests__/acquire.test.ts`)

---

## Security Considerations

1. **Credential expiration**: Credentials include expiration times (1 year default in provider-adapter)
2. **Self-signed credentials**: v1.5 allows "self" issuer — buyers can verify provider pubkey matches directory
3. **Capability attestation**: Credentials explicitly state supported intent types and settlement modes
4. **Production identity**: Use `PACT_PROVIDER_SECRET_KEY_B58` or keypair files — never use dev seeds in production

---

## Reputation V2 (v1.5.3+)

v1.5.3 introduces credential-aware, volume-weighted reputation scoring to improve provider selection quality.

### Features

- **Volume-weighted scoring**: Uses `paid_amount` (or `agreed_price`) with logarithmic weighting to prevent micro-trade farming
- **Credential-aware**: Providers with verified credentials receive a small reputation boost (5%)
- **Enhanced penalties**: 
  - `FAILED_PROOF` imposes strong penalty on provider reputation (up to 80% reduction)
  - `BUYER_STOPPED` penalizes buyer reputation more than seller (up to 30% reduction)
- **Micro-trade protection**: Receipts with value < 1e-6 are treated as 0 weight

### Usage

Enable V2 scoring by setting `useReputationV2: true` in `acquire()` input. V2 scoring is only applied when:
- `useReputationV2` is enabled
- Credential verification succeeded (`credentialPresent: true`)

Otherwise, the system falls back to V1 scoring for backward compatibility.

The demo CLI enables V2 scoring by default for improved selection quality.

---

## What's Next

Possible future enhancements (not in v1.5):

- **External wallet integration**: Direct integration with external wallet providers for key management
- **Third-party credential issuers**: Beyond self-signed credentials, support for trusted third-party issuers
- **Credential revocation lists**: Mechanisms to revoke compromised or expired credentials
- **Credential chaining / delegation**: Support for credential chains and delegated attestations
- **Hardware security module (HSM) integration**: Enhanced security for production key management
- **Credential refresh / rotation**: Automated credential renewal and rotation workflows

These features may be considered for future versions but are explicitly **not** in v1.5.

