# Pact Evidence Viewer Specification

**Version:** `evidence_viewer/1.0`  
**Audience:** Auditors, General Counsel, Compliance Officers, Regulators  
**Purpose:** Read-only evidence viewer for Auditor Packs (ZIP archives)

---

## Purpose

The Evidence Viewer is a **read-only lens** over evidence bundles. It provides a structured, human-readable interface to review Pact transaction evidence without requiring command-line tools or JSON parsing expertise.

The viewer operates on **Auditor Packs** (`.zip` files) generated by `pact-verifier auditor-pack`. It extracts and displays structured information from the pack's JSON artifacts, presenting it in panels optimized for different review workflows.

**Core Principle:** The viewer is a presentation layer. It does not generate, modify, or validate evidence. All verification must be performed using `pact-verifier auditor-pack-verify`.

---

## Non-Goals

The Evidence Viewer explicitly does **not** provide:

- **Transaction controls:** No ability to initiate, modify, or cancel transactions
- **Policy editing:** No ability to create, modify, or delete policies
- **Live data:** No connection to live transaction systems or real-time updates
- **Hosting:** No server-side storage, API endpoints, or data persistence
- **Evidence generation:** No ability to create or modify auditor packs
- **Verification execution:** Verification is performed via CLI integration, not in-app

The viewer is **presentation-only**. All trust and verification flows through the verifier CLI.

---

## Data Contract

The Evidence Viewer reads from an **Auditor Pack ZIP** with the following structure:

```
auditor_pack.zip
├── manifest.json                    # Package metadata and summary
├── checksums.sha256                 # File integrity checksums
├── constitution/
│   └── CONSTITUTION_v1.md          # Rules document
├── input/
│   └── transcript.json             # Original transcript (pact-transcript/4.0)
└── derived/
    ├── gc_view.json                # GC View (gc_view/1.0)
    ├── judgment.json                # DBL Judgment (dbl/2.0)
    └── insurer_summary.json         # Insurer Summary (insurer_summary/1.0)
```

### Required JSON Fields by Panel

#### 1. Case Header
- **Source:** `manifest.json`
  - `transcript_id` (string)
  - `constitution_version` (string)
  - `constitution_hash` (string, first 16 chars + "...")
  - `created_at_ms` (number, ISO 8601 format)
  - `tool_version` (string)
  - `audit_tier` (optional, "T1" | "T2" | "T3") → Informational only; see [TIERED_VERIFICATION_NOTE.md](./TIERED_VERIFICATION_NOTE.md)
  - `audit_sla` (optional, string) → Informational only
- **Source:** `derived/gc_view.json`
  - `executive_summary.status` (string) → Display as case status badge
  - `audit` (optional) → `tier`, `sla`, `note` (tier affects audit schedule, not admissibility)
- **Source:** `pact-verifier auditor-pack-verify` output
  - `ok` (boolean) → Verification status badge
  - `checksums_ok` (boolean)
  - `recompute_ok` (boolean)

#### 2. Outcome Panel
- **Source:** `derived/gc_view.json`
  - `executive_summary.status` (string)
  - `executive_summary.what_happened` (string)
  - `executive_summary.money_moved` (boolean) → **Explicitly call out**
  - `executive_summary.final_outcome` (string)
  - `executive_summary.settlement_attempted` (boolean)

#### 3. Integrity Panel
- **Source:** `derived/gc_view.json`
  - `integrity.hash_chain` ("VALID" | "INVALID")
  - `integrity.signatures_verified.verified` (number)
  - `integrity.signatures_verified.total` (number)
  - `integrity.final_hash_validation` ("MATCH" | "MISMATCH" | "UNVERIFIABLE")
  - `integrity.notes` (string[])
- **Source:** `pact-verifier auditor-pack-verify` output
  - `recompute_ok` (boolean) → Recompute verification status
  - `mismatches` (string[]) → Display if recompute_ok=false

#### 4. Responsibility Panel
- **Source:** `derived/judgment.json`
  - `dblDetermination` (string) → Fault domain
  - `requiredNextActor` ("BUYER" | "PROVIDER" | "RAIL" | "SETTLEMENT" | "ARBITER" | "NONE")
  - `requiredAction` (string) → Action enum
  - `terminal` (boolean)
  - `confidence` (number, 0.0-1.0)
- **Source:** `derived/gc_view.json`
  - `responsibility.last_valid_signed_hash` (string, first 16 chars + "...") → LVSH
  - `responsibility.blame_explanation` (string)

#### 5. Insurance Panel
- **Source:** `derived/insurer_summary.json`
  - `coverage` ("COVERED" | "COVERED_WITH_SURCHARGE" | "ESCROW_REQUIRED" | "EXCLUDED")
  - `risk_factors` (string[])
  - `surcharges` (string[])
  - `buyer.tier` ("A" | "B" | "C") → If present
  - `buyer.passport_score` (number) → If present
  - `provider.tier` ("A" | "B" | "C") → If present
  - `provider.passport_score` (number) → If present
  - `constitution_warning` (string) → If present

#### 6. Evidence Files Panel
- **Links to files in ZIP:**
  - `input/transcript.json`
  - `derived/gc_view.json`
  - `derived/judgment.json`
  - `derived/insurer_summary.json`
  - `derived/merkle_digest.json` (future; doc-only in v4.0.5-rc1 — see [MERKLE_DIGEST_v1.md](../MERKLE_DIGEST_v1.md); viewer may display if present for forward compatibility)
  - `constitution/CONSTITUTION_v1.md`
  - `checksums.sha256`
  - `manifest.json`

#### 7. "Verify Locally" CTA
- **Action:** Execute `node packages/verifier/dist/bin/pact-verifier.js auditor-pack-verify --zip <pack_path>` (from repo root; do not use global `pact-verifier`)
- **Display:** Show JSON output or parse and display key fields
- **Status:** Green if `ok=true`, red if `ok=false`

---

## Panel Specifications

### Panel 1: Case Header

**Layout:** Top banner, full width

**Fields:**
- **Status Badge:** `executive_summary.status` (color-coded: green=COMPLETED, red=FAILED_*, yellow=ABORTED_*)
- **Transcript ID:** `transcript_id` (monospace, truncated with ellipsis)
- **Constitution:** `constitution_version` + hash (first 16 chars)
- **Verification Status:** Badge showing `ok` from verify output (green checkmark if `ok=true`, red X if `ok=false`)
- **Generated:** ISO 8601 timestamp from `created_at_ms`

**Visual Hierarchy:** Status badge most prominent, transcript ID secondary, metadata tertiary.

---

### Panel 2: Outcome Panel

**Layout:** Left column, primary content area

**Fields:**
- **Status:** `executive_summary.status` (large, bold)
- **What Happened:** `executive_summary.what_happened` (paragraph text)
- **Money Moved:** **Explicit boolean display** - "Yes" or "No" with icon
- **Final Outcome:** `executive_summary.final_outcome` (summary text)
- **Settlement Attempted:** `executive_summary.settlement_attempted` (boolean)

**Design:** Card layout with clear visual separation. Money moved field must be prominently displayed.

---

### Panel 3: Integrity Panel

**Layout:** Right column, top

**Fields:**
- **Hash Chain:** `integrity.hash_chain` (badge: green="VALID", red="INVALID")
- **Signatures:** `integrity.signatures_verified.verified` / `integrity.signatures_verified.total` (e.g., "3/3 verified")
- **Final Hash:** `integrity.final_hash_validation` (badge)
- **Recompute Verification:** `recompute_ok` from verify output (badge)
- **Notes:** `integrity.notes` (bulleted list, if present)
- **Mismatches:** `mismatches` from verify output (if `recompute_ok=false`, show as warnings)
- **Merkle digest (when present, future):** Date (UTC), root (truncated), leaf index, constitution hash (truncated), signer (truncated when present) — not emitted by verifier in v4.0.5-rc1; see [MERKLE_DIGEST_v1.md](../MERKLE_DIGEST_v1.md)

**Design:** Status indicators with color coding. Expandable section for notes/mismatches.

---

### Panel 4: Responsibility Panel

**Layout:** Right column, middle

**Fields:**
- **Fault Domain:** `dblDetermination` (badge: "NO_FAULT", "BUYER_AT_FAULT", "PROVIDER_AT_FAULT", etc.)
- **Required Next Actor:** `requiredNextActor` (if not "NONE", display prominently)
- **Required Action:** `requiredAction` (action enum, e.g., "RETRY", "ABORT", "REMEDIATE_POLICY")
- **Terminal:** `terminal` (boolean badge: "Terminal" or "Non-Terminal")
- **Confidence:** `confidence` (0.0-1.0, displayed as percentage with progress bar)
- **LVSH:** `last_valid_signed_hash` (monospace, truncated)
- **Blame Explanation:** `blame_explanation` (paragraph text)

**Design:** Clear attribution with visual hierarchy. Required action/actor highlighted if not terminal.

---

### Panel 5: Insurance Panel

**Layout:** Right column, bottom

**Fields:**
- **Coverage Decision:** `coverage` (badge: color-coded by decision)
- **Risk Factors:** `risk_factors` (bulleted list, each as badge)
- **Surcharges:** `surcharges` (bulleted list, each as badge)
- **Buyer Tier:** `buyer.tier` + `buyer.passport_score` (if present)
- **Provider Tier:** `provider.tier` + `provider.passport_score` (if present)
- **Constitution Warning:** `constitution_warning` (if present, display as alert)

**Design:** Underwriting-focused layout. Coverage decision most prominent.

---

### Panel 6: Evidence Files Panel

**Layout:** Bottom section, full width

**Fields:**
- **File Links:** Clickable links to each file in the ZIP:
  - Transcript JSON
  - GC View JSON
  - Judgment JSON
  - Insurer Summary JSON
  - Constitution Markdown
  - Checksums File
  - Manifest JSON

**Design:** File browser-style list. Each link opens file content in new panel or downloads.

---

### Panel 7: "Verify Locally" CTA

**Layout:** Floating action button or prominent button in header

**Action:**
1. Execute: `node packages/verifier/dist/bin/pact-verifier.js auditor-pack-verify --zip <pack_path>`
2. Parse JSON output
3. Display results:
   - **Status Badge:** Green if `ok=true`, red if `ok=false`
   - **Checksums:** `checksums_ok` (boolean)
   - **Recompute:** `recompute_ok` (boolean)
   - **Mismatches:** `mismatches` (if any, show as expandable list)

**Design:** Prominent button. Results displayed in modal or expandable panel.

---

## Wireframe Outline

```
┌─────────────────────────────────────────────────────────────┐
│ [CASE HEADER]                                                │
│ [Status Badge] Transcript ID | Constitution | Verification  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ [OUTCOME PANEL]          │ [INTEGRITY PANEL]                │
│ Status: COMPLETED        │ Hash Chain: VALID                 │
│ What Happened: ...       │ Signatures: 3/3                   │
│ Money Moved: YES         │ Recompute: OK                      │
│ Final Outcome: ...       │                                    │
│                          │ [RESPONSIBILITY PANEL]             │
│                          │ Fault: NO_FAULT                   │
│                          │ Next Actor: NONE                  │
│                          │ Action: NONE                      │
│                          │ Confidence: 95%                    │
│                          │                                    │
│                          │ [INSURANCE PANEL]                  │
│                          │ Coverage: COVERED                  │
│                          │ Risk Factors: []                   │
│                          │ Surcharges: []                     │
│                          │ Buyer: Tier A (0.01)              │
│                          │ Provider: Tier A (0.01)           │
├─────────────────────────────────────────────────────────────┤
│ [EVIDENCE FILES]                                             │
│ • transcript.json • gc_view.json • judgment.json • ...      │
├─────────────────────────────────────────────────────────────┤
│ [Verify Locally Button]                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## Implementation Notes

### ZIP Extraction
- Viewer must extract ZIP to temporary directory or use in-memory ZIP library
- All file paths are relative to ZIP root
- Handle missing files gracefully (show "Not available" rather than error)

### JSON Parsing
- All JSON files must be valid JSON (handle parse errors gracefully)
- Version fields must match expected versions:
  - `gc_view.json`: `version: "gc_view/1.0"`
  - `judgment.json`: `version: "dbl/2.0"`
  - `insurer_summary.json`: `version: "insurer_summary/1.0"`

### Bundle and loading
- **Lazy-loaded heavy libraries:** PDF (jsPDF) and ZIP (JSZip) libraries are loaded on demand when the user first exports a PDF, generates the claims package, or loads/downloads from a pack. This keeps the initial bundle smaller and improves first-load performance. Export and download actions may show a brief loading state while the chunk loads; failures to load (e.g. network) should be surfaced to the user.

### Verification Integration
- Viewer displays the verify command; run it from repo root via `node packages/verifier/dist/bin/pact-verifier.js` (see [WORKFLOW_CONVENTIONS.md](../WORKFLOW_CONVENTIONS.md))
- Execute verification as subprocess
- Capture stdout (JSON) and stderr (errors) separately
- Parse JSON output for display
- Handle CLI errors gracefully (show error message)

### Display Requirements
- **Institutional tone:** No marketing language, focus on facts
- **Color coding:** Consistent use of green (valid/success), red (invalid/failure), yellow (warning)
- **Monospace fonts:** For hashes, IDs, technical values
- **Responsive:** Must work on desktop (primary) and tablet (secondary)
- **Accessibility:** WCAG 2.1 AA minimum

---

## Acceptance Criteria

✅ Spec exists and clearly states the viewer is a lens over evidence bundles  
✅ All 7 panels defined with required fields  
✅ Data contract specifies ZIP structure and JSON field mappings  
✅ Wireframe outline provided  
✅ Non-goals explicitly stated  
✅ "Verify Locally" CTA specification included

